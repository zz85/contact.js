<!DOCTYPE html>
<html>
  <head>
	<title>Sample Contact.js TouchPad - Sends sensor device</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"> 
	<style type="text/css">
		html {
			overflow: hidden;
			position: fixed;
		}
		body { margin: 0px; overflow: hidden; }
		button { 
			height: 40px;
			background: #333;
			color: #ddd;
		}
	</style>
</head>
<body>

	<div style="position: absolute; z-index: 200">
			<!-- <textarea id="keyin">

            </textarea> -->
            <script>
                window.onkeydown = (e) => {
                    console.log(e.keyCode);
                    connection.sendType('ftv', [e.keyCode])
                }

                // keyin
            </script>
			<div id="dirinfo"></div>
	</div>
	<script src="src/wire.js"></script>
	<script src="src/connection.js"></script>
	<script src="src/transmitter.js"></script>
	<script>
	var mouseMode = true;

	function sendKeyTap(key) {
		connection.sendType('kt', {
			key: key
		})
	}

	function sendString(input) {
		if (input) connection.sendType('rt', {
			text: input
		});
	}
	</script>
	
	<script type="text/javascript">

	class Vec2 {
		constructor(x, y) {
			this.x = x;
			this.y = y;
		}

		distSq() {
			return this.x * this.x + this.y * this.y;
		}

		dist() {
			return Math.sqrt(this.distSq());
		}

		angle() {
			return Math.atan2(this.y, this.x)
		}

		normal() {
			var d = this.dist();
			return new Vec2(this.x / d, this.y / d);
		}

		dot(v) {
			return this.x * v.x + this.y * v.y;
		}

		cosSim(b) {
			// cosine similarity
			var a = this;
			
			return a.dot(b) / (a.dist() * b.dist());
		}
	}

	var up = new Vec2(0, -1);
	var right = new Vec2(1, 0);
	var down = new Vec2(0, 1);
	var left = new Vec2(-1, 0);
	var ANGLE_THRESHOLD = 0.8;
	var MOVE_RADIUS = 100;

	var canvas;
	var ctx;
	var w = 0;
	var h = 0;

	var timer;
	var touches = [];
	var connection;
	var touchStart;

	function animate() {
		requestAnimationFrame(animate);
		update();
	}

	function update() {
		ctx.save();
		var dpr = window.devicePixelRatio;
		ctx.scale(dpr, dpr);
		ctx.clearRect(0, 0, w, h);

		ctx.fillStyle = 'red';
		ctx.fillText(connection && connection.status, 10, 20);

		if (touchStart && touchStart[0]) {
			// touch point
			ctx.beginPath();
			ctx.arc(touchStart[0].clientX, touchStart[0].clientY, 20, 0, 2 * Math.PI, true);

			ctx.fillStyle = "rgba(255, 0, 0, 0.2)";
			ctx.fill();

			// move radius
			ctx.beginPath();
			ctx.strokeStyle = 'pink'
			ctx.lineWidth = 4;
			ctx.arc(touchStart[0].clientX, touchStart[0].clientY, MOVE_RADIUS, 0, 2 * Math.PI, true);
			ctx.stroke()
		}

		var i, len, px, py, touch;
		for (i=0, len = touches.length; i<len; i++) {
			touch = touches[i];
			px = touch.clientX;
			py = touch.clientY;

			ctx.beginPath();
			ctx.arc(px, py, 20, 0, 2 * Math.PI, true);

			ctx.fillStyle = "rgba(255, 0, 0, 0.2)";
			ctx.fill();

			ctx.lineWidth = 2;
			ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
			ctx.stroke();

			ctx.moveTo(touchStart[0].clientX, touchStart[0].clientY);
			ctx.lineTo(px, py);
			ctx.stroke()
		}

		ctx.restore();
	}


	function start() {
		w = window.innerWidth;
		h = window.innerHeight;
		canvas = document.createElement('canvas');

		var dpr = window.devicePixelRatio;
		canvas.width = w * dpr;
		canvas.height = h * dpr;
		canvas.style = 'position: absolute; z-index: 10'
		canvas.style.width = w + 'px';
		canvas.style.height = h + 'px';

		ctx = canvas.getContext('2d');

		document.body.appendChild(canvas);

		var target = canvas; // window

		function checkDir() {
			if (!touchStart) return
			var end = touches[0];
			var start = touchStart[0]
			var vec = new Vec2(end.clientX - start.clientX, end.clientY - start.clientY)
			console.log('angle', vec.angle())

			// console.log('up', isUp)

			var moveDist = vec.dist();

			if (mouseMode) {
				dirinfo.innerHTML = 'dot mouse mode';
				
				// .002
				// after first interval, repeat at every 25ms
				// connection.sendType('mm', [ vec.x * 0.25, vec.y * 0.25, clickInterval])
				// clickInterval = 25;

				// .003
				// var n = vec.normal()
				// connection.sendType('mm', [ n.x * 10, n.y * 10, clickInterval])
				// clickInterval = 25

				// .004
				// var n = vec.normal()
				// connection.sendType('mm', [ n.x * 5, n.y * 5, clickInterval])
				// clickInterval = 5 / (moveDist / MOVE_RADIUS)

				var n = vec.normal()
				var mul = 4;

				if (moveDist < MOVE_RADIUS * 0.25) mul = 1
				if (moveDist > MOVE_RADIUS * 2) mul *= 2

				connection.sendType('mm', [ n.x * 1 * mul, n.y * 1 * mul, clickInterval])
				clickInterval = 10

				// http://ted.selker.com/documents/resumefiles/other%20publications/trackpoint%20II.PDF

				return
			}

			
			var toMove = moveDist >= MOVE_RADIUS || true;
			var upDiff = vec.cosSim(up);
			var isUp = upDiff > ANGLE_THRESHOLD;
			var isRight = vec.cosSim(right) > ANGLE_THRESHOLD;
			var isDown = vec.cosSim(down) > ANGLE_THRESHOLD;
			var isLeft = vec.cosSim(left) > ANGLE_THRESHOLD;

			var dir = !toMove ? '' : isUp ? 'up' : isDown ? 'down' : isLeft ? 'left' : isRight ? 'right': '';
			console.log(dir)
			dirinfo.innerHTML = dir;

			if (dir) {
				if (!mouseMode) sendKeyTap(dir)
				// var DIST = 8;
				// connection.sendType('mm', [ isLeft ? -DIST : isRight ? DIST : 0, isUp ? -DIST : isDown ? DIST : 0, clickInterval])

				clickInterval /= 1.2
				clickInterval = Math.max(clickInterval, 40 / (moveDist / MOVE_RADIUS))
			}
		}

		function onClick() {
			checkDir()
				
			setTimeout(onClick, clickInterval);
		}

		target.addEventListener('touchend', function(event) {
			console.log('end', touches);
			if (event.touches.length === 0 && touches[0]) {
				checkDir()
			}
			touches = event.touches;
			touchStart = null
			clearTimeout(dirInterval)
		}, false);

		target.addEventListener('touchmove', function(event) {
			touches = event.touches;
			// checkDir()
		}, false);

		target.addEventListener('touchstart', function(event) {
			event.preventDefault()
			touches = event.touches;
			touchStart = touches
			console.log('start', touchStart)
			clickInterval = 200
			dirInterval = setTimeout(onClick, clickInterval)
		}, false);

		target.addEventListener('resize', function(event) {
			w = window.innerWidth;
			h = window.innerHeight;
			canvas.width = w;
			canvas.height = h;
		}, false);

		animate();
	}

	start()

	var target = 'ws://' + location.hostname + ':8081/touchpad';
		var connection = new Connection(target, handler);
		connection.open();

	/*
	 * mode 1. ibm red dot mouse / pointing stick / trackpoint / https://xkcd.com/243/
		.001: repeat rate exp increase, use amp of vector (with min to activvate, and max).
		.002: after first slow repeat, 2nd is rapid
		
     * mode 2. keyboard directions only
     https://kodi.wiki/view/HOW-TO:Install_Kodi_on_Fire_TV#ADB_command_line
	 */
	</script>


</body>
</html>